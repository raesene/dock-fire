name: Build Guest Kernel

on:
  workflow_dispatch:
    inputs:
      kernel_series:
        description: 'Kernel series to build (e.g. 6.1)'
        required: false
        default: '6.1'
  push:
    paths:
      - 'scripts/build-kernel.sh'
      - '.github/workflows/build-kernel.yml'
  schedule:
    # Weekly on Monday at 06:00 UTC
    - cron: '0 6 * * 1'

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      KERNEL_SERIES: ${{ github.event.inputs.kernel_series || '6.1' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect latest patch version
        id: version
        run: |
          VERSION=$(curl -fsSL https://www.kernel.org/releases.json \
            | jq -r --arg s "${KERNEL_SERIES}." \
              '.releases[] | select(.version | startswith($s)) | .version' \
            | head -1)
          if [[ -z "$VERSION" ]]; then
            echo "::error::Could not detect latest ${KERNEL_SERIES}.x version"
            exit 1
          fi
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
          echo "tag=kernel-${VERSION}" >> "$GITHUB_OUTPUT"
          echo "Detected kernel version: ${VERSION}"

      - name: Check if release already exists
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ steps.version.outputs.tag }}"
          if gh release view "$TAG" &>/dev/null; then
            echo "Release ${TAG} already exists, skipping build"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          else
            echo "skip=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Install build dependencies
        if: steps.check.outputs.skip != 'true'
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq \
            build-essential flex bison bc libelf-dev libssl-dev wget curl jq

      - name: Build kernel
        if: steps.check.outputs.skip != 'true'
        run: ./scripts/build-kernel.sh "$KERNEL_SERIES"

      - name: Create GitHub Release
        if: steps.check.outputs.skip != 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: "Kernel ${{ steps.version.outputs.version }}"
          body: |
            Firecracker-compatible guest kernel built from Linux ${{ steps.version.outputs.version }}.

            Based on Firecracker's official `microvm-kernel-ci-x86_64-${{ env.KERNEL_SERIES }}.config` with additional options for Docker-in-VM support (overlayfs, cgroups, namespaces, netfilter).

            ## Usage
            ```bash
            # Download and install
            curl -fsSL <release-url>/vmlinux.bin -o /var/lib/vmm/images/kernels/vmlinux.bin

            # Or use with DOCK_FIRE_KERNEL_PATH
            export DOCK_FIRE_KERNEL_PATH=/path/to/vmlinux.bin
            docker run --runtime=dock-fire --net=none --rm alpine echo hello
            ```
          files: vmlinux.bin
